==================================
Conversation Single State Workflow
==================================

This is a functional test for ploneboard_conversation_without_review_workflow.
It is to showcase how a member user can add a new conversation in an existing topic (or directly inside a messageboard) without requesting a review to publish. Its published by default once created.

Setting up and logging in
-------------------------

Setting up browser and loging in

    >>> app = layer['app']
    >>> from plone.testing.z2 import Browser
    >>> browser = Browser(app)
    >>> browser.handleErrors = False
    >>> browser.addHeader('Authorization', 'Basic admin:secret')
    >>> portal = layer['portal']
    >>> portal_url = 'http://nohost/plone'
    >>> browser.open(portal_url)

Enable Workflows
----------------

    >>> portal.portal_workflow.setChainForPortalTypes(('messageboard',), ('ploneboard_messageboard_workflow'),)
    >>> portal.portal_workflow.setChainForPortalTypes(('topic',), ('ploneboard_topic_workflow'),)
    >>> portal.portal_workflow.setChainForPortalTypes(('conversation',), ('ploneboard_conversation_without_review_workflow'),)

Add message board
-----------------

"As an administrator I can add a message board."

    >>> from plone.app.testing import setRoles
    >>> from plone.app.testing import TEST_USER_ID
    >>> setRoles(portal, TEST_USER_ID, ['Manager'])
    >>> import transaction
    >>> transaction.commit()
    >>> browser.open(portal_url + '/++add++messageboard')
    >>> browser.getControl(name='form.widgets.IDublinCore.title').value = "My New Message Board"
    >>> browser.getControl(name='form.widgets.category').value = "Get Started\r\nPromotion\r\nCommunications"
    >>> browser.getControl("Save").click()
    >>> "My New Message Board" in browser.contents
    True
    >>> "Get Started" in browser.contents
    True
    >>> "Promotion" in browser.contents
    True
    >>> "Communications" in browser.contents
    True

Workflow Actions
----------------

Make the messageboard public

    >>> browser.open(portal_url + '/my-new-message-board')
    >>> mb_url = portal_url + '/my-new-message-board'
    >>> browser.getLink(id='workflow-transition-publish').click()
    >>> 'Published' in browser.contents
    True
    >>> import transaction
    >>> transaction.commit()

===============================================================================================

Add Topic and Conversation inside

===============================================================================================

"As an administrator I can add a topic to an existing message board"

    >>> browser.getLink('Topic').click()
    >>> browser.getControl(name='form.widgets.IBasic.title').value = "Topic under messageboard"
    >>> browser.getControl("Save").click()
    >>> "Topic under messageboard" in browser.contents
    True
    >>> browser.open(mb_url + '/topic-under-messageboard')
    >>> topic_url = mb_url + '/topic-under-messageboard'
    >>> browser.getLink('Publish').click()
    >>> 'Published' in browser.contents
    True
    >>> import transaction
    >>> transaction.commit()

"As a member I can add a new conversation inside an existing topic"

    >>> portal.acl_users._doAddUser('member_user', 'secret', ['Member'], [])
    <PloneUser 'member_user'>
    >>> from plone.app.testing import login, logout
    >>> login(portal, 'member_user')
    >>> browser.getLink('Conversation').click()
    >>> browser.getControl(name='form.widgets.IBasic.title').value = "Conversation1 inside topic"
    >>> browser.getControl(name='form.widgets.text').value = "This is the first conversation inside a topic"
    >>> browser.getControl("Save").click()
    >>> "Conversation1 inside topic" in browser.contents
    True
    >>> browser.open(topic_url+'/conversation1-inside-topic')

Published by default

    >>> "Published" in browser.contents
    True
    >>> logout()


============================================================================================================

    Add a new conversation under messageboard as member

============================================================================================================

    >>> browser.open(mb_url)

"As a member I can add a new conversation inside an existing messageboard"

    >>> portal.acl_users._doAddUser('member_user', 'secret', ['Member'], [])
    <PloneUser 'member_user'>
    >>> from plone.app.testing import login, logout
    >>> login(portal, 'member_user')
    >>> browser.getLink('Conversation').click()
    >>> browser.getControl(name='form.widgets.IBasic.title').value = "Direct Conversation"
    >>> browser.getControl(name='form.widgets.text').value = "This is a conversation not under any topic"
    >>> browser.getControl("Save").click()
    >>> "Direct Conversation" in browser.contents
    True
    >>> direct_conv_url = mb_url + '/direct-conversation'
    >>> browser.open(direct_conv_url)

Published by default

    >>> "Published" in browser.contents
    True
    >>> logout()


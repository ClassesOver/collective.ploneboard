==================================
Conversation Simple Review Workflow
==================================

This is a functional test for try_conv_w workflow.
It is to showcase how a memmber user can add a new conversation in an existing topic (or directly inside a messageboard) with requesting for a review to publish. 
Reviewer reviews it and then it gets published.

Setting up and logging in
-------------------------

Setting up browser and loging in

    >>> app = layer['app']
    >>> from plone.testing.z2 import Browser
    >>> browser = Browser(app)
    >>> browser.handleErrors = False
    >>> browser.addHeader('Authorization', 'Basic admin:secret')
    >>> portal = layer['portal']
    >>> portal_url = 'http://nohost/plone'
    >>> browser.open(portal_url)

Enable Workflows
----------------

    >>> portal.portal_workflow.setChainForPortalTypes(('messageboard',), ('messageboard_workflow'),)
    >>> portal.portal_workflow.setChainForPortalTypes(('topic',), ('try_topi_w'),)
    >>> portal.portal_workflow.setChainForPortalTypes(('conversation',), ('try_conv_w'),)

Add message board
-----------------

"As an administrator I can add a message board."

    >>> from plone.app.testing import setRoles
    >>> from plone.app.testing import TEST_USER_ID
    >>> setRoles(portal, TEST_USER_ID, ['Manager'])
    >>> import transaction
    >>> transaction.commit()
    >>> browser.open(portal_url + '/++add++messageboard')
    >>> browser.getControl(name='form.widgets.IDublinCore.title').value = "Another Message Board"
    >>> browser.getControl(name='form.widgets.category').value = "Get Started\r\nPromotion\r\nCommunications"
    >>> browser.getControl("Save").click()
    >>> "Another Message Board" in browser.contents
    True
    >>> "Get Started" in browser.contents
    True
    >>> "Promotion" in browser.contents
    True
    >>> "Communications" in browser.contents
    True

Workflow Actions
----------------

Make the messageboard public

    >>> browser.open(portal_url + '/another-message-board')
    >>> mb_url = portal_url + '/another-message-board'
    >>> browser.getLink(id='workflow-transition-publish').click()
    >>> 'Published' in browser.contents
    True
    >>> transaction.commit()

===============================================================================================

Add Topic and Conversation inside

===============================================================================================

"As an administrator I can add a topic to an existing message board"

    >>> browser.getLink('Topic').click()
    >>> browser.getControl(name='form.widgets.IBasic.title').value = "Topic under messageboard"
    >>> browser.getControl("Save").click()
    >>> "Topic under messageboard" in browser.contents
    True
    >>> browser.open(mb_url + '/topic-under-messageboard')
    >>> topic_url = mb_url + '/topic-under-messageboard'
    >>> browser.getLink('Publish').click()
    >>> 'Published' in browser.contents
    True
    >>> transaction.commit()

"As a member I can add a new conversation inside an existing topic"

    >>> portal.acl_users._doAddUser('member_user', 'secret', ['Member'], [])
    <PloneUser 'member_user'>
    >>> from plone.app.testing import login, logout
    >>> login(portal, 'member_user')
    >>> browser.getLink('Conversation').click()
    >>> browser.getControl(name='form.widgets.IBasic.title').value = "Conversation1 inside topic"
    >>> browser.getControl(name='form.widgets.text').value = "This is the first conversation inside a topic"
    >>> browser.getControl("Save").click()
    >>> "Conversation1 inside topic" in browser.contents
    True
    >>> c_url = topic_url+'/conversation1-inside-topic'
    >>> browser.open(c_url)

Private by default

    >>> "Private" in browser.contents
    True

Submit for publication

    >>> browser.getLink(id='workflow-transition-submit').click()
    >>> browser.open(c_url)
    >>> 'Pending' in browser.contents
    True
    >>> transaction.commit()

Retract it
    
    >>> browser.open(c_url)
    >>> browser.getLink(id='workflow-transition-retract').click()
    >>> browser.open(c_url)
    >>> "Private" in browser.contents
    True
    >>> transaction.commit()

Submit for publication now

    >>> browser.open(c_url)
    >>> browser.getLink(id='workflow-transition-submit').click()
    >>> browser.open(c_url)
    >>> 'Pending' in browser.contents
    True
    >>> transaction.commit()
    >>> logout()

Publish the conversation as the Manager

    >>> portal.acl_users._doAddUser('manager', 'secret', ['Manager'], [])
    <PloneUser 'manager'>
    >>> from plone.app.testing import login, logout
    >>> login(portal, 'manager')
    >>> browser.open(c_url)
    >>> browser.getLink(id='workflow-transition-publish').click()
    >>> "Published" in browser.contents
    True
    >>> logout()

============================================================================================================

    Add a new conversation under messageboard as member

============================================================================================================

    >>> browser.open(mb_url)

"As a member I can add a new conversation inside an existing messageboard"

    >>> portal.acl_users._doAddUser('member_user', 'secret', ['Member'], [])
    <PloneUser 'member_user'>
    >>> from plone.app.testing import login, logout
    >>> login(portal, 'member_user')
    >>> browser.getLink('Conversation').click()
    >>> browser.getControl(name='form.widgets.IBasic.title').value = "Direct Conversation"
    >>> browser.getControl(name='form.widgets.text').value = "This is a conversation not under any topic"
    >>> browser.getControl("Save").click()
    >>> "Direct Conversation" in browser.contents
    True
    >>> direct_conv_url = mb_url + '/direct-conversation'
    >>> browser.open(direct_conv_url)

Private by default

    >>> "Private" in browser.contents
    True

Submit for publication

    >>> browser.getLink(id='workflow-transition-submit').click()
    >>> browser.open(direct_conv_url)
    >>> 'Pending' in browser.contents
    True
    >>> transaction.commit()
    >>> logout()

Reject the conversation as the Manager

    >>> portal.acl_users._doAddUser('manager', 'secret', ['Manager'], [])
    <PloneUser 'manager'>
    >>> from plone.app.testing import login, logout
    >>> login(portal, 'manager')
    >>> browser.open(direct_conv_url)
    >>> browser.getLink(id='workflow-transition-reject').click()
    >>> browser.open(direct_conv_url)
    >>> "Private" in browser.contents
    True
    >>> logout()
